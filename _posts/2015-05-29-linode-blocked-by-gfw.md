---
layout: post
title: "20150529服务器第一次被GFW墙掉"
description: "服务器被墙"
category: "服务器"
tags: 
  - 服务器
---

#### 简介

20150529早上，基友东给我QQ发来一条消息“翻墙不好使了，服务器无法登录”，我清楚的记得前一分钟我特么还在逍遥的上谷歌，所以第一反应是网络问题。

接下来用SecureCRT登录服务器查看情况，发现我这边也无法登录。翻墙服务无法使用（Shadowsocks）、服务器上挂的所有网站均无法访问，特么的第一反应是被黑了。昨天携程刚被“物理删除”，吓尿我了，赶紧走我AWS的服务器进行ssh登录，发现好使。

成功登录上，赶紧看是不是被人黑了。`last | more` 结果显示最近登录的都是我自己，排除服务器信息泄漏的可能。

接下来查看各种服务是否正常运行：`netstat -nlp`。发现所有端口，服务都运行正常。。。

再看存储是否异常：`df -h`，一切ok……当时就纳闷了，给我的直觉是linode自己的问题，遂去微博搜索“linode”关键字（大事件这上面总会有点蛛丝马迹）。可惜只能发现零星的几个人在吐槽，并不是大规模的集体复现。

至此基本能确定是被GFW墙掉了，但是为了印证我的猜测，我继续做了如下步骤。。。

在本地`ping`服务器，发现ping不通，然后切换到我AWS服务器上，发现ping一切正常。然后Shadowsocks切换成我AWS的翻墙服务，访问放在linode服务器上的网站A，直接访问不行，挂上代理以后访问正常！！！ WTF，确实被墙了。

接下来肯定是到linode上提工单换ip，但为了一劳永逸。我干脆直接换机房了~工单上一来一往折腾了大半天 + 数据迁移将近一个小时。服务器终于能正常登录了。

最后就是扫尾工作：直接关闭服务器之前配置的google反向代理（听说这个很容易被扫描到，估计也是这次被墙的原因）、关闭服务器VPN服务。

做完这些工作后发现网站也好使了，不过跟PHP相关的貌似还存在问题，经查询。是`fastcgi`服务没启动。

{%highlight bash%}
# 一行命令搞定
spawn-fcgi -a 127.0.0.1 -p 9000 -C 10 -u www-data -f /usr/bin/php-cgi
{%endhighlight%}

#### 番外

1. 添加备份任务

2. AWS的Shadowsocks添加了流量统计功能（毕竟流量有限，超过了会被扣钱~）

#### 常用的服务器工具

1. 流量统计：`iftop`、`ifstat`、`vnstat`。我用的是vnstat

2. 防止暴力破解密码：`fail2ban`。当然，最好是限制使用root用户直接登录
